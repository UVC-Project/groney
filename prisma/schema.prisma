// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for both students and teachers
model User {
  id            String   @id @default(cuid())
  username      String   @unique
  password      String
  role          UserRole
  classId       String?
  activeClassId String?  // For teachers managing multiple classes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  classMember ClassUser[]

  submissions Submission[]
  purchases   Purchase[]
  activities  Activity[]

  @@index([classId])
  @@index([activeClassId])
  @@map("users")
}

enum UserRole {
  STUDENT
  TEACHER
}

// Class model
model Class {
  id         String   @id @default(cuid())
  name       String
  school     String
  classCode  String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  members ClassUser[]
  mascot      Mascot?
  sectors     Sector[]
  activities  Activity[]
  submissions Submission[]
  purchases   Purchase[]

  @@index([classCode])
  @@map("classes")
}

model ClassUser {
  classId String
  userId  String

  class Class @relation(fields: [classId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([classId, userId])
  @@map("class_users")
}

// Mascot model
model Mascot {
  id              String   @id @default(cuid())
  classId         String   @unique
  thirst          Int      @default(100)
  hunger          Int      @default(100)
  happiness       Int      @default(100)
  cleanliness     Int      @default(100)
  level           Int      @default(1)
  xp              Int      @default(0)
  coins           Int      @default(0)
  equippedHat     String?
  equippedAccessory String?
  equippedColor   String?
  lastDecayAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@map("mascots")
}

// Sector model (areas of the schoolyard)
model Sector {
  id        String     @id @default(cuid())
  classId   String
  name      String
  type      SectorType
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  class    Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  missions Mission[]

  @@index([classId])
  @@map("sectors")
}

enum SectorType {
  TREES
  FLOWERS
  POND
  ANIMALS
  GARDEN
  PLAYGROUND
  COMPOST
  OTHER
  CHICKENS // @deprecated - use ANIMALS instead
}

enum MissionCategory {
  THIRST
  HUNGER
  HAPPINESS
  CLEANLINESS
}

enum MissionStatus {
  AVAILABLE
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

// Mission model
model Mission {
  id              String   @id @default(cuid())
  sectorId        String
  title           String
  description     String
  xpReward        Int
  coinReward      Int
  thirstBoost     Int      @default(0)
  hungerBoost     Int      @default(0)
  happinessBoost  Int      @default(0)
  cleanlinessBoost Int     @default(0)
  requiresPhoto   Boolean  @default(true)
  requiresQR      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  coordinates_x   Float    @default(50.0)
  coordinates_y   Float    @default(50.0)
  category        MissionCategory @default(THIRST)
  status          MissionStatus @default(AVAILABLE)

  sector      Sector       @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@index([sectorId])
  @@map("missions")
}

// Submission model (proof of work)
model Submission {
  id          String           @id @default(cuid())
  missionId   String
  userId      String
  classId     String
  photoUrl    String?
  qrScanned   Boolean          @default(false)
  status      SubmissionStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  mission Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([missionId])
  @@index([userId])
  @@index([classId])
  @@index([status])
  @@map("submissions")
}

enum SubmissionStatus {
  PENDING
  COMPLETED
  REJECTED
}

// Shop Item model
model ShopItem {
  id        String       @id @default(cuid())
  name      String
  type      ItemType
  price     Int
  imageUrl  String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  purchases Purchase[]

  @@map("shop_items")
}

enum ItemType {
  HAT
  ACCESSORY
  COLOR
}

// Purchase model
model Purchase {
  id        String   @id @default(cuid())
  userId    String
  itemId    String
  classId   String
  createdAt DateTime @default(now())

  user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item  ShopItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  class Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@index([classId])
  @@map("purchases")
}

// Activity Feed model
model Activity {
  id        String       @id @default(cuid())
  classId   String
  userId    String
  type      ActivityType
  content   String
  imageUrl  String?
  createdAt DateTime     @default(now())

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([createdAt])
  @@map("activities")
}

enum ActivityType {
  MISSION_COMPLETED
  PURCHASE
  LEVEL_UP
}
